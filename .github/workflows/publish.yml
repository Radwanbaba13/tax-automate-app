name: Publish

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout git repo
        uses: actions/checkout@v3

      - name: Install Node and NPM
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r Python/requirements.txt

      - name: Build Python executables
        run: npm run build:python

      - name: Validate required secrets
        run: |
          # Fail fast if required secrets are missing (DB_*)
          if [ -z "${{ secrets.DB_HOST }}" ] || [ -z "${{ secrets.DB_USER }}" ] || [ -z "${{ secrets.DB_PASSWORD }}" ] || [ -z "${{ secrets.DB_NAME }}" ]; then
            echo "Missing one or more required DB secrets (DB_HOST, DB_USER, DB_PASSWORD, DB_NAME)."
            exit 1
          fi
        shell: bash

      - name: Create production .env file
        run: |
          # Write secrets to .env.production (secrets must be set in repo settings)
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env.production
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env.production
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env.production
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env.production
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env.production
          # Optional DB_PORT and other settings (uncomment if you add them as secrets)
          # echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env.production
        shell: bash

      - name: Install and build Electron app
        run: |
          npm install
          npm run postinstall
          npm run build

      - name: Publish Windows release
        env:
          # Add Windows code signing certificate if available
          # CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm exec electron-builder -- --publish always --win

  # build-macos:
  #   runs-on: macos-latest

  #   steps:
  #     - name: Checkout git repo
  #       uses: actions/checkout@v3

  #     - name: Install Node and NPM
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 22
  #         cache: npm

  #     - name: Setup Python
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: '3.11'

  #     - name: Install Python dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install pyinstaller
  #         pip install -r Python/requirements.txt

  #     - name: Build Python executables
  #       run: npm run build:python

  #     - name: Install and build Electron app
  #       run: |
  #         npm install
  #         npm run postinstall
  #         npm run build

  #     - name: Publish macOS release
  #       env:
  #         # Add macOS code signing certificates if available
  #         # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_ID_PASS }}
  #         # APPLE_ID: ${{ secrets.APPLE_ID }}
  #         # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  #         # CSC_LINK: ${{ secrets.MAC_CSC_LINK }}
  #         # CSC_KEY_PASSWORD: ${{ secrets.MAC_CSC_KEY_PASSWORD }}
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         npm exec electron-builder -- --publish always --mac
